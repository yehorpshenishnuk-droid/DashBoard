import os
import time
import requests
import sys
from datetime import date
from flask import Flask, render_template_string, jsonify

app = Flask(__name__)

POSTER_TOKEN = os.getenv("POSTER_TOKEN")
ACCOUNT_NAME = "poka-net3"

# ======================
# –ì—Ä—É–ø–ø—ã –ß–µ–±—É—Ä–µ–∫—ñ–≤
# ======================
CHEBUREK_GROUPS = {
    "–ß–µ–±—É—Ä–µ–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é": [
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é(+–ú—ñ–∫—Å –°–∏—Ä—ñ–≤ 20 –≥)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é (+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å, +–ú—ñ–∫—Å –°–∏—Ä—ñ–≤)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é (+ —Å—É–º—ñ—à –∑–µ–ª–µ–Ω—ñ, 10 –≥)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é (+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é (+–°–∏—Ä —á–µ–¥–µ—Ä 12 –≥)",
    ],
    "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é": [
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å, +–ú—ñ–∫—Å –°–∏—Ä—ñ–≤)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é(+ —Å—É–º—ñ—à –∑–µ–ª–µ–Ω—ñ, 10 –≥)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é(+–°–∏—Ä —á–µ–¥–µ—Ä 12 –≥)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é(+–ú—ñ–∫—Å –°–∏—Ä—ñ–≤ 20 –≥)",
    ],
    "–ß–µ–±—É—Ä–µ–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é": [
        "–ß–µ–±—É—Ä–µ–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é",
        "–ß–µ–±—É—Ä–µ–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é (+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å, +–ú—ñ–∫—Å –°–∏—Ä—ñ–≤)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é (+ —Å—É–º—ñ—à –∑–µ–ª–µ–Ω—ñ, 10 –≥)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é (+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é (+–°–∏—Ä —á–µ–¥–µ—Ä 12 –≥)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é(+–ú—ñ–∫—Å –°–∏—Ä—ñ–≤ 20 –≥)",
    ],
    "–ß–µ–±—É—Ä–µ–∫ –∑ –∫—É—Ä–∫–æ—é": [
        "–ß–µ–±—É—Ä–µ–∫ –∑ –∫—É—Ä–∫–æ—é",
        "–ß–µ–±—É—Ä–µ–∫ –∑ –∫—É—Ä–∫–æ—é(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å, +–ú—ñ–∫—Å –°–∏—Ä—ñ–≤)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ –∫—É—Ä–∫–æ—é(+ —Å—É–º—ñ—à –∑–µ–ª–µ–Ω—ñ, 10 –≥)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ –∫—É—Ä–∫–æ—é(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ –∫—É—Ä–∫–æ—é(+–°–∏—Ä —á–µ–¥–µ—Ä 12 –≥)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ –∫—É—Ä–∫–æ—é(+–ú—ñ–∫—Å –°–∏—Ä—ñ–≤ 20 –≥)",
    ],
    "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–∏—Ä–æ–º": [
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–∏—Ä–æ–º",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–∏—Ä–æ–º(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å, +–ú—ñ–∫—Å –°–∏—Ä—ñ–≤)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–∏—Ä–æ–º(+ —Å—É–º—ñ—à –∑–µ–ª–µ–Ω—ñ, 10 –≥)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–∏—Ä–æ–º(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–∏—Ä–æ–º(+–°–∏—Ä —á–µ–¥–µ—Ä 12 –≥)",
        "–ß–µ–±—É—Ä–µ–∫ –∑ —Å–∏—Ä–æ–º(+–ú—ñ–∫—Å –°–∏—Ä—ñ–≤ 20 –≥)",
    ],
}

# ======================
# –ì—Ä—É–ø–ø—ã –Ø–Ω—Ç–∏–∫—ñ–≤
# ======================
YANTYK_GROUPS = {
    "–Ø–Ω—Ç–∏–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é": [
        "–Ø–Ω—Ç–∏–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é",
        "–Ø–Ω—Ç–∏–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é(+–ú—ñ–∫—Å –°–∏—Ä—ñ–≤ 20 –≥)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é (+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å, +–ú—ñ–∫—Å –°–∏—Ä—ñ–≤)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é (+ —Å—É–º—ñ—à –∑–µ–ª–µ–Ω—ñ, 10 –≥)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é (+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é (+–°–∏—Ä —á–µ–¥–µ—Ä 12 –≥)",
    ],
    "–Ø–Ω—Ç–∏–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é": [
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é",
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å, +–ú—ñ–∫—Å –°–∏—Ä—ñ–≤)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é(+ —Å—É–º—ñ—à –∑–µ–ª–µ–Ω—ñ, 10 –≥)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é(+–°–∏—Ä —á–µ–¥–µ—Ä 12 –≥)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–≤–∏–Ω–∏–Ω–æ—é(+–ú—ñ–∫—Å –°–∏—Ä—ñ–≤ 20 –≥)",
    ],
    "–Ø–Ω—Ç–∏–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é": [
        "–Ø–Ω—Ç–∏–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é",
        "–Ø–Ω—Ç–∏–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é (+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å, +–ú—ñ–∫—Å –°–∏—Ä—ñ–≤)",
        "–Ø–Ω—Ç–∏–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é (+ —Å—É–º—ñ—à –∑–µ–ª–µ–Ω—ñ, 10 –≥)",
        "–Ø–Ω—Ç–∏–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é (+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å)",
        "–Ø–Ω—Ç–∏–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é (+–°–∏—Ä —á–µ–¥–µ—Ä 12 –≥)",
        "–Ø–Ω—Ç–∏–∫ –∑ –±–∞—Ä–∞–Ω–Ω–∏–Ω–æ—é(+–ú—ñ–∫—Å –°–∏—Ä—ñ–≤ 20 –≥)",
    ],
    "–Ø–Ω—Ç–∏–∫ –∑ –∫—É—Ä–∫–æ—é": [
        "–Ø–Ω—Ç–∏–∫ –∑ –∫—É—Ä–∫–æ—é",
        "–Ø–Ω—Ç–∏–∫ –∑ –∫—É—Ä–∫–æ—é(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å, +–ú—ñ–∫—Å –°–∏—Ä—ñ–≤)",
        "–Ø–Ω—Ç–∏–∫ –∑ –∫—É—Ä–∫–æ—é(+ —Å—É–º—ñ—à –∑–µ–ª–µ–Ω—ñ, 10 –≥)",
        "–Ø–Ω—Ç–∏–∫ –∑ –∫—É—Ä–∫–æ—é(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å)",
        "–Ø–Ω—Ç–∏–∫ –∑ –∫—É—Ä–∫–æ—é(+–°–∏—Ä —á–µ–¥–µ—Ä 12 –≥)",
        "–Ø–Ω—Ç–∏–∫ –∑ –∫—É—Ä–∫–æ—é(+–ú—ñ–∫—Å –°–∏—Ä—ñ–≤ 20 –≥)",
    ],
    "–Ø–Ω—Ç–∏–∫ –∑ —Å–∏—Ä–æ–º": [
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–∏—Ä–æ–º",
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–∏—Ä–æ–º(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å, +–ú—ñ–∫—Å –°–∏—Ä—ñ–≤)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–∏—Ä–æ–º(+ —Å—É–º—ñ—à –∑–µ–ª–µ–Ω—ñ, 10 –≥)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–∏—Ä–æ–º(+–¢–æ–º–∞—Ç–∏ + –ó–µ–ª–µ–Ω—å)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–∏—Ä–æ–º(+–°–∏—Ä —á–µ–¥–µ—Ä 12 –≥)",
        "–Ø–Ω—Ç–∏–∫ –∑ —Å–∏—Ä–æ–º(+–ú—ñ–∫—Å –°–∏—Ä—ñ–≤ 20 –≥)",
    ],
}

# ======================
# –•–æ–ª–æ–¥–Ω–∏–π —Ü–µ—Ö (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)
# ======================
COLD_DISHES = {
    493: "–ü–µ–ª—å–º–µ–Ω—ñ –∑ —Ñ—ñ–ª–µ –º–æ–ª–æ–¥–æ—ó –∫—É—Ä–∫–∏, 500 –≥",
    495: "–ü–µ–ª—å–º–µ–Ω—ñ —è–∫ –º–∞—é—Ç—å –±—É—Ç–∏ –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é, 500 –≥",
    510: "–ü–µ–ª—å–º–µ–Ω—ñ —Å–≤–∏–Ω–æ-—è–ª–æ–≤–∏—á—ñ , 500–≥",
    399: "–°–∞–ª–∞—Ç –∑ –∑–∞–ø–µ—á–µ–Ω–∏–º–∏ –æ–≤–æ—á–∞–º–∏",
    487: "–°–∞–ª–∞—Ç –∑ —Ö–∞–º–æ–Ω–æ–º —Ç–∞ –∫–∞—Ä–∞–º–µ–ª—ñ–∑–æ–≤–∞–Ω–æ—é –≥—Ä—É—à–µ—é",
    219: "–¢–µ–ø–ª–∏–π —Å–∞–ª–∞—Ç –∑ —Ç–µ–ª—è—Ç–∏–Ω–æ—é",
    55: "–°–∞–ª–∞—Ç —Ü–µ–∑–∞—Ä—å",
    40: "–ì—Ä–µ—Ü—å–∫–∏–π —Å–∞–ª–∞—Ç",
    234: "–ü—ñ—Å–Ω–∏–π –æ–≤–æ—á–µ–≤–∏–π –∑ –≥–æ—Ä—ñ—Ö–æ–≤–æ—é –∑–∞–ø—Ä–∞–≤–∫–æ—é",
    53: "–û–≤–æ—á–µ–≤–∏–π —Å–∞–ª–∞—Ç –∑ –≥–æ—Ä—ñ—Ö–æ–≤–æ—é –∑–∞–ø—Ä–∞–≤–∫–æ—é",
    273: "–õ–µ–≥–∫–∏–π —Å–∞–ª–∞—Ç –∑ –∑–∞–ø–µ—á–µ–Ω–∏–º –≥–∞—Ä–±—É–∑–æ–º",
    438: "–ú—ñ–∫—Å —Å–∞–ª–∞—Ç—É –∑ –∫—É—Ä–∫–æ—é —Å—É–≤—ñ–¥",
    288: "–ö—Ä–µ–º-—Å—É–ø –≥–∞—Ä–±—É–∑–æ–≤–∏–π –∑ –±–µ–∫–æ–Ω–æ–º",
    262: "–ö—Ä–µ–º-—Å—É–ø –≥—Ä–∏–±–Ω–∏–π –∑ –≥—Ä—ñ–Ω–∫–∞–º–∏",
    37: "–°—É–ø –í—É—à–∫–∞",
    42: "–ú'—è—Å–Ω–∞ —Å–æ–ª—è–Ω–∫–∞",
    206: "–û–∫—Ä–æ—à–∫–∞ –Ω–∞ –∞–π—Ä–∞–Ω—ñ –∑ –∫–æ–≤–±–∞—Å–æ—é",
    384: "–û–∫—Ä–æ—à–∫–∞ –Ω–∞ –∞–π—Ä–∞–Ω—ñ –∑ —è–∑–∏–∫–æ–º —Ç–µ–ª—è—á–∏–º, 300 –≥",
    44: "–ú–∞–Ω—Ç–∏ –∑ —è–ª–æ–≤–∏—á–∏–Ω–æ—é (–∫–ª–∞—Å–∏—á–Ω—ñ)",
    521: "–ü–µ–ª—å–º–µ–Ω—ñ –∑ —Ñ—ñ–ª–µ –∫—É—Ä–∫–∏",
    429: "–ú–∞–Ω—Ç–∏ –∑ —Å–∏—Ä–æ–º —Ç–∞ –∑–µ–ª–µ–Ω—å—é",
    9: "–ú–∞–Ω—Ç–∏ –∑ —è–ª–æ–≤–∏—á–∏–Ω–æ—é —Ç–∞ —Å–≤–∏–Ω–∏–Ω–æ—é",
}

# –û–±—ä–µ–¥–∏–Ω—è–µ–º –≥—Ä—É–ø–ø—ã
GROUPS = {**CHEBUREK_GROUPS, **YANTYK_GROUPS}

last_update = 0
cache = {"hot": {}, "cold": {}}


def fetch_sales(group_mode=True):
    """–ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–¥–∞–∂–∏ –∏–∑ Poster API –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å"""
    today = date.today().strftime("%Y-%m-%d")
    url = (
        f"https://{ACCOUNT_NAME}.joinposter.com/api/dash.getProductsSales"
        f"?token={POSTER_TOKEN}&date_from={today}&date_to={today}"
    )

    resp = requests.get(url)
    print("DEBUG Poster API response:", resp.text[:200], file=sys.stderr, flush=True)

    try:
        data = resp.json().get("response", [])
    except Exception as e:
        print("ERROR parsing JSON:", e, file=sys.stderr, flush=True)
        return {"total": 0, "top3": [("–ü–æ–º–∏–ª–∫–∞", 0)]}

    sales_count = {}
    total_orders = 0

    for item in data:
        name = item.get("product_name", "").strip()
        quantity = int(float(item.get("count", 0)))
        product_id = int(item.get("product_id", 0))

        if group_mode:  # –ì–æ—Ä—è—á–∏–π —Ü–µ—Ö (–≥—Ä—É–ø–ø—ã)
            for main_name, variants in GROUPS.items():
                if name in variants:
                    sales_count[main_name] = sales_count.get(main_name, 0) + quantity
                    total_orders += quantity
                    break
        else:  # –•–æ–ª–æ–¥–Ω—ã–π —Ü–µ—Ö (–ø–æ ID)
            if product_id in COLD_DISHES:
                sales_count[COLD_DISHES[product_id]] = sales_count.get(
                    COLD_DISHES[product_id], 0
                ) + quantity
                total_orders += quantity

    top3 = sorted(sales_count.items(), key=lambda x: x[1], reverse=True)[:3]

    return {"total": total_orders, "top3": [(i, c) for i, c in top3]}


@app.route("/api/hot")
def api_hot():
    global last_update, cache
    if time.time() - last_update > 30:
        cache["hot"] = fetch_sales(group_mode=True)
    return jsonify(cache["hot"])


@app.route("/api/cold")
def api_cold():
    global last_update, cache
    if time.time() - last_update > 30:
        cache["cold"] = fetch_sales(group_mode=False)
        last_update = time.time()
    return jsonify(cache["cold"])


@app.route("/")
def index():
    template = """
    <html>
    <head>
        <style>
            body { font-family: Arial, sans-serif; background: #111; color: #eee; text-align: center; }
            h2 { font-size: 40px; margin-bottom: 20px; }
            .grid { display: flex; justify-content: center; gap: 50px; max-width: 1400px; margin: auto; }
            .block { width: 650px; padding: 30px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.7); animation: fadeIn 1s; }
            .hot { border: 4px solid #ff6600; }
            .cold { border: 4px solid #0099ff; }
            .item { font-size: 28px; margin: 8px 0; }
            .total { margin-top: 40px; font-size: 34px; font-weight: bold; }
            .updated { margin-top: 10px; font-size: 18px; color: #aaa; }
            @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        </style>
    </head>
    <body>
        <div class="grid">
            <div class="block hot">
                <h2>üî• –ì–∞—Ä—è—á–∏–π –¶–ï–•</h2>
                <p id="hot_total" style="font-size:32px; font-weight:bold;">–í—Å—å–æ–≥–æ: ...</p>
                <div id="hot_top3">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="block cold">
                <h2>‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω–∏–π –¶–ï–•</h2>
                <p id="cold_total" style="font-size:32px; font-weight:bold;">–í—Å—å–æ–≥–æ: ...</p>
                <div id="cold_top3">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
        <div class="total" id="all_total">–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω—å: ...</div>
        <div class="updated" id="updated_time">–û–Ω–æ–≤–ª–µ–Ω–æ: ...</div>

        <script>
        function medal(index) {
            if (index === 0) return "ü•á";
            if (index === 1) return "ü•à";
            if (index === 2) return "ü•â";
            return "";
        }

        async function updateData() {
            try {
                const hotRes = await fetch('/api/hot');
                const hot = await hotRes.json();
                document.getElementById('hot_total').innerText = "–í—Å—å–æ–≥–æ: " + hot.total + " –∑–∞–º–æ–≤–ª–µ–Ω—å";
                let hotDiv = document.getElementById('hot_top3');
                hotDiv.innerHTML = "üèÜ –¢–û–ü-3 –ø—Ä–æ–¥–∞–∂—ñ:";
                hot.top3.forEach((item, index) => {
                    hotDiv.innerHTML += `<div class="item">${medal(index)} ${item[0]} ‚Äî ${item[1]}</div>`;
                });

                const coldRes = await fetch('/api/cold');
                const cold = await coldRes.json();
                document.getElementById('cold_total').innerText = "–í—Å—å–æ–≥–æ: " + cold.total + " –∑–∞–º–æ–≤–ª–µ–Ω—å";
                let coldDiv = document.getElementById('cold_top3');
                coldDiv.innerHTML = "üèÜ –¢–û–ü-3 –ø—Ä–æ–¥–∞–∂—ñ:";
                cold.top3.forEach((item, index) => {
                    coldDiv.innerHTML += `<div class="item">${medal(index)} ${item[0]} ‚Äî ${item[1]}</div>`;
                });

                const all = hot.total + cold.total;
                const totalDiv = document.getElementById('all_total');
                totalDiv.innerText = "–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω—å: " + all;
                totalDiv.style.color = all > 100 ? "lime" : (all > 50 ? "yellow" : "red");

                const now = new Date();
                document.getElementById('updated_time').innerText = "–û–Ω–æ–≤–ª–µ–Ω–æ: " + now.toLocaleTimeString();
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", e);
            }
        }

        setInterval(updateData, 30000);
        window.onload = updateData;
        </script>
    </body>
    </html>
    """
    return render_template_string(template)


if __name__ == "__main__":
    port = int(os.getenv("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
